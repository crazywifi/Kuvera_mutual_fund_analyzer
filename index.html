<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuvera Mutual Fund Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .upload-section {
            padding: 40px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f9ff;
        }
        
        .upload-area.dragover {
            background: #e8f4f8;
            border-color: #4CAF50;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        #fileInput {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .dashboard {
            display: none;
            padding: 30px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            border-left: 5px solid #667eea;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card.investment { border-left-color: #667eea; }
        .card.current { border-left-color: #4CAF50; }
        .card.gain { border-left-color: #FF9800; }
        .card.cagr { border-left-color: #E91E63; }
        .card.tax { border-left-color: #9C27B0; }
        
        .card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .card .value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        
        .card .sub-value {
            font-size: 0.9em;
            color: #888;
            margin-top: 5px;
        }
        
        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: inline-block;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .positive { color: #4CAF50; font-weight: bold; }
        .negative { color: #f44336; font-weight: bold; }
        
        .projection-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-field {
            display: flex;
            flex-direction: column;
        }
        
        .input-field label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .input-field input, .input-field select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .input-field input:focus, .input-field select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .projection-results {
            display: none;
            margin-top: 30px;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fund-detail {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        
        .fund-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .fund-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 0.9em;
            color: #666;
        }
        
        .yearly-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .year-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            border-top: 4px solid #667eea;
        }
        
        .year-card h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Kuvera Mutual Fund Analyzer</h1>
            <p>Comprehensive Portfolio Analysis & Future Projections</p>
        </div>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <h3>Upload Your Kuvera Transaction File</h3>
                <p>Drag & drop your CSV file here or click to browse</p>
                <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                    File format: Date, Folio Number, Fund Name, Order, Units, NAV, Current NAV, Amount
                </p>
                <input type="file" id="fileInput" accept=".csv">
                <br><br>
                <button class="btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
                <button class="btn" onclick="loadSampleData()" style="background: #4CAF50;">Load Sample Data</button>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing your portfolio...</p>
            </div>
        </div>
        
        <div class="dashboard" id="dashboard">
            <div class="summary-cards">
                <div class="card investment">
                    <h3>Total Investment</h3>
                    <div class="value" id="totalInvestment">‚Çπ0</div>
                    <div class="sub-value">Across all years</div>
                </div>
                <div class="card current">
                    <h3>Current Value</h3>
                    <div class="value" id="currentValue">‚Çπ0</div>
                    <div class="sub-value">Based on latest NAV</div>
                </div>
                <div class="card gain">
                    <h3>Total Gain/Loss</h3>
                    <div class="value" id="totalGain">‚Çπ0</div>
                    <div class="sub-value" id="gainPercent">0%</div>
                </div>
                <div class="card cagr">
                    <h3>Overall CAGR</h3>
                    <div class="value" id="overallCAGR">0%</div>
                    <div class="sub-value">Annualized return</div>
                </div>
                <div class="card tax">
                    <h3>Tax Liability (Est.)</h3>
                    <div class="value" id="taxLiability">‚Çπ0</div>
                    <div class="sub-value">On current gains</div>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">Overview</button>
                <button class="tab" onclick="showTab('yearly')">Year-wise Analysis</button>
                <button class="tab" onclick="showTab('funds')">Fund Details</button>
                <button class="tab" onclick="showTab('transactions')">Transactions</button>
                <button class="tab" onclick="showTab('projection')">Future Projection</button>
            </div>
            
            <div id="overview" class="tab-content active">
                <div class="section">
                    <h2>Portfolio Growth Over Time</h2>
                    <div class="chart-container">
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>
                
                <div class="section">
                    <h2>Investment vs Current Value by Year</h2>
                    <div class="chart-container">
                        <canvas id="yearlyChart"></canvas>
                    </div>
                </div>
                
                <div class="section">
                    <h2>Asset Allocation</h2>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="allocationChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="yearly" class="tab-content">
                <div class="section">
                    <h2>Year-wise Performance Analysis</h2>
                    <div class="info-box">
                        <strong>How to read:</strong> Each card shows the performance for that specific year. 
                        CAGR is calculated based on the holding period from investment date.
                    </div>
                    <div class="yearly-breakdown" id="yearlyBreakdown">
                        <!-- Year cards will be inserted here -->
                    </div>
                </div>
                
                <div class="section">
                    <h2>Yearly Summary Table</h2>
                    <table id="yearlyTable">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Invested</th>
                                <th>Current Value</th>
                                <th>Absolute Gain</th>
                                <th>CAGR</th>
                                <th>Transactions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div id="funds" class="tab-content">
                <div class="section">
                    <h2>Individual Fund Performance</h2>
                    <div id="fundDetails">
                        <!-- Fund details will be inserted here -->
                    </div>
                </div>
                
                <div class="section">
                    <h2>Fund-wise Summary</h2>
                    <table id="fundTable">
                        <thead>
                            <tr>
                                <th>Fund Name</th>
                                <th>Folio</th>
                                <th>Units</th>
                                <th>Invested</th>
                                <th>Current Value</th>
                                <th>Gain/Loss</th>
                                <th>CAGR</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div id="transactions" class="tab-content">
                <div class="section">
                    <h2>All Transactions</h2>
                    <table id="transactionTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Fund</th>
                                <th>Type</th>
                                <th>Units</th>
                                <th>NAV</th>
                                <th>Current NAV</th>
                                <th>Amount</th>
                                <th>Days Held</th>
                                <th>Returns</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div id="projection" class="tab-content">
                <div class="projection-section">
                    <h2>üîÆ Future Wealth Projection</h2>
                    <div class="warning-box">
                        <strong>Disclaimer:</strong> Projections are based on your current CAGR and assume 
                        consistent future returns. Actual returns may vary significantly.
                    </div>
                    
                    <div class="input-group">
                        <div class="input-field">
                            <label>Additional Years</label>
                            <input type="number" id="projYears" value="10" min="1" max="50">
                        </div>
                        <div class="input-field">
                            <label>Monthly SIP Amount (‚Çπ)</label>
                            <input type="number" id="monthlySIP" value="25000" min="0" step="1000">
                        </div>
                        <div class="input-field">
                            <label>Expected CAGR (%)</label>
                            <input type="number" id="expectedCAGR" value="12" min="1" max="30" step="0.1">
                        </div>
                        <div class="input-field">
                            <label>Tax Bracket (%)</label>
                            <select id="taxBracket">
                                <option value="0">0% (No tax)</option>
                                <option value="10">10% (LTCG >1yr)</option>
                                <option value="15">15% (STCG <1yr)</option>
                                <option value="20">20% (With indexation)</option>
                                <option value="30" selected>30% (Highest slab)</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="calculateProjection()" style="width: 100%; font-size: 18px;">
                        Calculate Future Wealth
                    </button>
                    
                    <div class="projection-results" id="projectionResults">
                        <div class="summary-cards">
                            <div class="card investment">
                                <h3>Total Investment (Future)</h3>
                                <div class="value" id="projTotalInvestment">‚Çπ0</div>
                                <div class="sub-value">Current + Future SIPs</div>
                            </div>
                            <div class="card current">
                                <h3>Projected Value</h3>
                                <div class="value" id="projFinalValue">‚Çπ0</div>
                                <div class="sub-value">Before tax</div>
                            </div>
                            <div class="card gain">
                                <h3>Total Returns</h3>
                                <div class="value" id="projReturns">‚Çπ0</div>
                                <div class="sub-value" id="projReturnPercent">0%</div>
                            </div>
                            <div class="card tax">
                                <h3>After-Tax Value</h3>
                                <div class="value" id="projAfterTax">‚Çπ0</div>
                                <div class="sub-value" id="projTaxAmount">Tax: ‚Çπ0</div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <h2>Year-by-Year Projection</h2>
                            <div class="chart-container">
                                <canvas id="projectionChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="section">
                            <h2>Detailed Year-wise Breakdown</h2>
                            <table id="projectionTable">
                                <thead>
                                    <tr>
                                        <th>Year</th>
                                        <th>Annual Investment</th>
                                        <th>Cumulative Invested</th>
                                        <th>Portfolio Value</th>
                                        <th>Annual Gain</th>
                                        <th>Cumulative Gain</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let portfolioData = [];
        let charts = {};
        
        // Sample data matching the user's format
        const sampleData = `Date,Folio Number,Name of the Fund,Order,Units,NAV,Current Nav,Amount (INR)
2026-02-09,128681/17,360 One Focused Growth Direct Plan,buy,73.556,54.3775,53.6706,3999.8
2026-02-09,128681/17,360 One Focused Growth Direct Plan,buy,18.389,54.3775,53.6706,999.95
2026-02-09,27579939/19,HDFC Focused Growth Direct Plan,buy,18.221,274.399,275.215,4999.75
2026-02-06,91079026683,Axis Small Cap Growth Direct Plan,buy,33.908,117.96,119.68,3999.8
2026-02-06,91079026683,Axis Small Cap Growth Direct Plan,buy,8.477,117.96,119.68,999.95
2026-02-06,477258420294,Nippon India Small Cap Growth Direct Plan,buy,22.032,181.5471,183.4024,3999.8
2026-02-06,23865196,SBI Small Cap Growth Direct Plan,buy,13.54,184.627,186.0488,2499.88
2026-02-06,23865196,SBI Small Cap Growth Direct Plan,buy,2.708,184.627,186.0488,499.98
2026-02-06,23865196,SBI Small Cap Growth Direct Plan,buy,5.416,184.627,186.0488,999.95
2026-02-05,10456583,Parag Parikh Flexi Cap Growth Direct Plan,buy,53.437,93.5631,93.0828,4999.75
2026-01-07,128681/17,360 One Focused Growth Direct Plan,buy,18.37,54.4351,53.6706,999.95
2026-01-07,128681/17,360 One Focused Growth Direct Plan,buy,73.478,54.4351,53.6706,3999.8
2026-01-07,27579939/19,HDFC Focused Growth Direct Plan,buy,18.174,275.099,275.215,4999.75
2025-12-08,128681/17,360 One Focused Growth Direct Plan,buy,18.789,53.2211,53.6706,999.95
2025-12-08,128681/17,360 One Focused Growth Direct Plan,buy,75.154,53.2211,53.6706,3999.8
2024-03-01,477258420294,Nippon India Ultra Short Duration Growth Direct Plan,sell,5.658,4003.5545,4635.6565,22652.11`;
        
        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                processFile(file);
            } else {
                alert('Please upload a CSV file');
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
        });
        
        function loadSampleData() {
            processCSV(sampleData);
        }
        
        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => processCSV(e.target.result);
            reader.readAsText(file);
        }
        
        function processCSV(csvText) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('uploadArea').style.display = 'none';
            
            setTimeout(() => {
                parseData(csvText);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                updateDashboard();
            }, 500);
        }
        
        function parseData(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            portfolioData = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Handle quoted values properly
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let char of line) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                if (values.length >= 8) {
                    const date = new Date(values[0]);
                    const order = values[3].toLowerCase();
                    const units = parseFloat(values[4]) || 0;
                    const nav = parseFloat(values[5]) || 0;
                    const currentNav = parseFloat(values[6]) || nav;
                    const amount = parseFloat(values[7]) || 0;
                    
                    portfolioData.push({
                        date: date,
                        dateStr: values[0],
                        folio: values[1],
                        fundName: values[2],
                        order: order,
                        units: order === 'sell' ? -units : units,
                        nav: nav,
                        currentNav: currentNav,
                        amount: order === 'sell' ? -amount : amount,
                        years: (new Date() - date) / (365.25 * 24 * 60 * 60 * 1000)
                    });
                }
            }
            
            // Sort by date
            portfolioData.sort((a, b) => a.date - b.date);
        }
        
        function updateDashboard() {
            calculateSummary();
            renderYearlyAnalysis();
            renderFundDetails();
            renderTransactions();
            renderCharts();
        }
        
        function calculateSummary() {
            let totalInvested = 0;
            let currentValue = 0;
            let totalUnits = 0;
            
            // Group by fund to calculate holdings
            const fundHoldings = {};
            
            portfolioData.forEach(tx => {
                const key = tx.folio + '-' + tx.fundName;
                if (!fundHoldings[key]) {
                    fundHoldings[key] = {
                        fundName: tx.fundName,
                        folio: tx.folio,
                        units: 0,
                        invested: 0,
                        currentNav: tx.currentNav
                    };
                }
                
                fundHoldings[key].units += tx.units;
                if (tx.order === 'buy') {
                    fundHoldings[key].invested += tx.amount;
                    totalInvested += tx.amount;
                } else {
                    fundHoldings[key].invested += tx.amount; // amount is negative for sell
                    totalInvested += tx.amount;
                }
            });
            
            // Calculate current value
            Object.values(fundHoldings).forEach(fund => {
                if (fund.units > 0) {
                    currentValue += fund.units * fund.currentNav;
                }
            });
            
            const totalGain = currentValue - totalInvested;
            const gainPercent = totalInvested > 0 ? (totalGain / totalInvested) * 100 : 0;
            
            // Calculate overall CAGR using weighted average
            let weightedCAGR = 0;
            let totalWeight = 0;
            
            portfolioData.forEach(tx => {
                if (tx.order === 'buy' && tx.amount > 0) {
                    const years = tx.years;
                    if (years > 0) {
                        const cagr = ((tx.currentNav / tx.nav) ** (1/years) - 1) * 100;
                        weightedCAGR += cagr * tx.amount;
                        totalWeight += tx.amount;
                    }
                }
            });
            
            const overallCAGR = totalWeight > 0 ? weightedCAGR / totalWeight : 0;
            
            // Tax calculation (simplified LTCG at 10% above 1 lakh)
            const ltcg = Math.max(0, totalGain - 100000);
            const taxLiability = ltcg * 0.10;
            
            // Update display
            document.getElementById('totalInvestment').textContent = formatCurrency(totalInvested);
            document.getElementById('currentValue').textContent = formatCurrency(currentValue);
            
            const gainEl = document.getElementById('totalGain');
            gainEl.textContent = formatCurrency(totalGain);
            gainEl.className = 'value ' + (totalGain >= 0 ? 'positive' : 'negative');
            
            document.getElementById('gainPercent').textContent = 
                (totalGain >= 0 ? '+' : '') + gainPercent.toFixed(2) + '%';
            
            document.getElementById('overallCAGR').textContent = overallCAGR.toFixed(2) + '%';
            document.getElementById('taxLiability').textContent = formatCurrency(taxLiability);
            
            // Store for projections
            window.portfolioSummary = {
                totalInvested,
                currentValue,
                totalGain,
                overallCAGR,
                fundHoldings
            };
        }
        
        function renderYearlyAnalysis() {
            const yearData = {};
            
            portfolioData.forEach(tx => {
                const year = tx.date.getFullYear();
                if (!yearData[year]) {
                    yearData[year] = {
                        invested: 0,
                        currentValue: 0,
                        gain: 0,
                        transactions: 0,
                        buys: []
                    };
                }
                
                yearData[year].transactions++;
                
                if (tx.order === 'buy') {
                    yearData[year].invested += tx.amount;
                    const currentVal = tx.units * tx.currentNav;
                    yearData[year].currentValue += currentVal;
                    yearData[year].buys.push(tx);
                }
            });
            
            // Calculate CAGR for each year
            Object.keys(yearData).forEach(year => {
                const data = yearData[year];
                let weightedCAGR = 0;
                let totalAmount = 0;
                
                data.buys.forEach(tx => {
                    if (tx.years > 0) {
                        const cagr = ((tx.currentNav / tx.nav) ** (1/tx.years) - 1) * 100;
                        weightedCAGR += cagr * tx.amount;
                        totalAmount += tx.amount;
                    }
                });
                
                data.cagr = totalAmount > 0 ? weightedCAGR / totalAmount : 0;
                data.gain = data.currentValue - data.invested;
            });
            
            // Render year cards
            const container = document.getElementById('yearlyBreakdown');
            container.innerHTML = '';
            
            Object.keys(yearData).sort((a, b) => b - a).forEach(year => {
                const data = yearData[year];
                const gainClass = data.gain >= 0 ? 'positive' : 'negative';
                
                const card = document.createElement('div');
                card.className = 'year-card';
                card.innerHTML = `
                    <h4>${year}</h4>
                    <div class="stat-row">
                        <span>Invested:</span>
                        <strong>${formatCurrency(data.invested)}</strong>
                    </div>
                    <div class="stat-row">
                        <span>Current Value:</span>
                        <strong>${formatCurrency(data.currentValue)}</strong>
                    </div>
                    <div class="stat-row">
                        <span>Absolute Gain:</span>
                        <strong class="${gainClass}">${formatCurrency(data.gain)}</strong>
                    </div>
                    <div class="stat-row">
                        <span>CAGR:</span>
                        <strong>${data.cagr.toFixed(2)}%</strong>
                    </div>
                    <div class="stat-row">
                        <span>Transactions:</span>
                        <strong>${data.transactions}</strong>
                    </div>
                `;
                container.appendChild(card);
            });
            
            // Render table
            const tbody = document.querySelector('#yearlyTable tbody');
            tbody.innerHTML = '';
            
            Object.keys(yearData).sort((a, b) => b - a).forEach(year => {
                const data = yearData[year];
                const gainClass = data.gain >= 0 ? 'positive' : 'negative';
                
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${year}</strong></td>
                        <td>${formatCurrency(data.invested)}</td>
                        <td>${formatCurrency(data.currentValue)}</td>
                        <td class="${gainClass}">${formatCurrency(data.gain)}</td>
                        <td>${data.cagr.toFixed(2)}%</td>
                        <td>${data.transactions}</td>
                    </tr>
                `;
            });
            
            window.yearData = yearData;
        }
        
        function renderFundDetails() {
            const funds = {};
            
            portfolioData.forEach(tx => {
                const key = tx.folio + '-' + tx.fundName;
                if (!funds[key]) {
                    funds[key] = {
                        fundName: tx.fundName,
                        folio: tx.folio,
                        units: 0,
                        invested: 0,
                        currentNav: tx.currentNav,
                        transactions: []
                    };
                }
                
                funds[key].units += tx.units;
                funds[key].invested += tx.amount;
                funds[key].transactions.push(tx);
            });
            
            // Render fund cards
            const container = document.getElementById('fundDetails');
            container.innerHTML = '';
            
            Object.values(funds).forEach(fund => {
                if (fund.units <= 0) return; // Skip sold out funds
                
                const currentValue = fund.units * fund.currentNav;
                const gain = currentValue - fund.invested;
                const gainPercent = (gain / fund.invested) * 100;
                
                // Calculate CAGR
                let weightedCAGR = 0;
                let totalAmount = 0;
                
                fund.transactions.forEach(tx => {
                    if (tx.order === 'buy' && tx.years > 0) {
                        const cagr = ((tx.currentNav / tx.nav) ** (1/tx.years) - 1) * 100;
                        weightedCAGR += cagr * tx.amount;
                        totalAmount += tx.amount;
                    }
                });
                
                const cagr = totalAmount > 0 ? weightedCAGR / totalAmount : 0;
                
                const div = document.createElement('div');
                div.className = 'fund-detail';
                div.innerHTML = `
                    <div class="fund-name">${fund.fundName}</div>
                    <div class="fund-name" style="font-size: 0.9em; color: #666;">Folio: ${fund.folio}</div>
                    <div class="fund-stats">
                        <div>Units: <strong>${fund.units.toFixed(3)}</strong></div>
                        <div>Invested: <strong>${formatCurrency(fund.invested)}</strong></div>
                        <div>Current: <strong>${formatCurrency(currentValue)}</strong></div>
                        <div>Gain: <strong class="${gain >= 0 ? 'positive' : 'negative'}">${formatCurrency(gain)} (${gainPercent.toFixed(2)}%)</strong></div>
                        <div>CAGR: <strong>${cagr.toFixed(2)}%</strong></div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            // Render table
            const tbody = document.querySelector('#fundTable tbody');
            tbody.innerHTML = '';
            
            Object.values(funds).forEach(fund => {
                const currentValue = fund.units * fund.currentNav;
                const gain = currentValue - fund.invested;
                const gainClass = gain >= 0 ? 'positive' : 'negative';
                
                let weightedCAGR = 0;
                let totalAmount = 0;
                
                fund.transactions.forEach(tx => {
                    if (tx.order === 'buy' && tx.years > 0) {
                        const cagr = ((tx.currentNav / tx.nav) ** (1/tx.years) - 1) * 100;
                        weightedCAGR += cagr * tx.amount;
                        totalAmount += tx.amount;
                    }
                });
                
                const cagr = totalAmount > 0 ? weightedCAGR / totalAmount : 0;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${fund.fundName}</td>
                        <td>${fund.folio}</td>
                        <td>${fund.units.toFixed(3)}</td>
                        <td>${formatCurrency(fund.invested)}</td>
                        <td>${formatCurrency(currentValue)}</td>
                        <td class="${gainClass}">${formatCurrency(gain)}</td>
                        <td>${cagr.toFixed(2)}%</td>
                    </tr>
                `;
            });
        }
        
        function renderTransactions() {
            const tbody = document.querySelector('#transactionTable tbody');
            tbody.innerHTML = '';
            
            [...portfolioData].reverse().forEach(tx => {
                const daysHeld = Math.floor(tx.years * 365.25);
                const currentValue = tx.units * tx.currentNav;
                const returns = currentValue - tx.amount;
                const returnsClass = returns >= 0 ? 'positive' : 'negative';
                const typeClass = tx.order === 'buy' ? 'positive' : 'negative';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${tx.dateStr}</td>
                        <td>${tx.fundName}</td>
                        <td class="${typeClass}">${tx.order.toUpperCase()}</td>
                        <td>${Math.abs(tx.units).toFixed(3)}</td>
                        <td>‚Çπ${tx.nav.toFixed(4)}</td>
                        <td>‚Çπ${tx.currentNav.toFixed(4)}</td>
                        <td>${formatCurrency(Math.abs(tx.amount))}</td>
                        <td>${daysHeld} days</td>
                        <td class="${returnsClass}">${tx.order === 'buy' ? formatCurrency(returns) : '-'}</td>
                    </tr>
                `;
            });
        }
        
        function renderCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => chart.destroy());
            
            // Growth over time chart
            const monthData = {};
            portfolioData.forEach(tx => {
                const key = tx.date.toISOString().slice(0, 7); // YYYY-MM
                if (!monthData[key]) {
                    monthData[key] = { invested: 0, value: 0 };
                }
                if (tx.order === 'buy') {
                    monthData[key].invested += tx.amount;
                    monthData[key].value += tx.units * tx.currentNav;
                }
            });
            
            const sortedMonths = Object.keys(monthData).sort();
            let cumulativeInvested = 0;
            let cumulativeValue = 0;
            const investedData = [];
            const valueData = [];
            
            sortedMonths.forEach(month => {
                cumulativeInvested += monthData[month].invested;
                cumulativeValue += monthData[month].value;
                investedData.push(cumulativeInvested);
                valueData.push(cumulativeValue);
            });
            
            const ctx1 = document.getElementById('growthChart').getContext('2d');
            charts.growth = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Amount Invested',
                        data: investedData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true
                    }, {
                        label: 'Current Value',
                        data: valueData,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + (value/100000).toFixed(1) + 'L';
                                }
                            }
                        }
                    }
                }
            });
            
            // Yearly comparison chart
            const years = Object.keys(window.yearData).sort();
            const yearInvested = years.map(y => window.yearData[y].invested);
            const yearCurrent = years.map(y => window.yearData[y].currentValue);
            
            const ctx2 = document.getElementById('yearlyChart').getContext('2d');
            charts.yearly = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Invested',
                        data: yearInvested,
                        backgroundColor: '#667eea'
                    }, {
                        label: 'Current Value',
                        data: yearCurrent,
                        backgroundColor: '#4CAF50'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + (value/100000).toFixed(1) + 'L';
                                }
                            }
                        }
                    }
                }
            });
            
            // Allocation pie chart
            const fundValues = {};
            portfolioData.forEach(tx => {
                if (tx.order === 'buy') {
                    if (!fundValues[tx.fundName]) fundValues[tx.fundName] = 0;
                    fundValues[tx.fundName] += tx.units * tx.currentNav;
                }
            });
            
            const ctx3 = document.getElementById('allocationChart').getContext('2d');
            charts.allocation = new Chart(ctx3, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(fundValues),
                    datasets: [{
                        data: Object.values(fundValues),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }
        
        function calculateProjection() {
            const years = parseInt(document.getElementById('projYears').value);
            const monthlySIP = parseFloat(document.getElementById('monthlySIP').value);
            const expectedCAGR = parseFloat(document.getElementById('expectedCAGR').value) / 100;
            const taxRate = parseFloat(document.getElementById('taxBracket').value) / 100;
            
            const currentValue = window.portfolioSummary.currentValue;
            const currentInvested = window.portfolioSummary.totalInvested;
            
            // Future value calculation
            let futureValue = currentValue * Math.pow(1 + expectedCAGR, years);
            let totalSIP = 0;
            
            // Add future SIPs with growth
            for (let i = 1; i <= years; i++) {
                const yearlySIP = monthlySIP * 12;
                totalSIP += yearlySIP;
                // SIP grows for remaining years
                futureValue += yearlySIP * Math.pow(1 + expectedCAGR, years - i);
            }
            
            const totalInvested = currentInvested + totalSIP;
            const totalReturns = futureValue - totalInvested;
            const taxAmount = totalReturns * taxRate;
            const afterTaxValue = futureValue - taxAmount;
            
            // Display results
            document.getElementById('projTotalInvestment').textContent = formatCurrency(totalInvested);
            document.getElementById('projFinalValue').textContent = formatCurrency(futureValue);
            document.getElementById('projReturns').textContent = formatCurrency(totalReturns);
            document.getElementById('projReturnPercent').textContent = 
                ((totalReturns / totalInvested) * 100).toFixed(2) + '%';
            document.getElementById('projAfterTax').textContent = formatCurrency(afterTaxValue);
            document.getElementById('projTaxAmount').textContent = 'Tax: ' + formatCurrency(taxAmount);
            
            document.getElementById('projectionResults').style.display = 'block';
            
            // Generate year-wise projection table
            const tbody = document.querySelector('#projectionTable tbody');
            tbody.innerHTML = '';
            
            let runningValue = currentValue;
            let runningInvested = currentInvested;
            let cumulativeGain = 0;
            
            for (let year = 1; year <= years; year++) {
                const yearlySIP = monthlySIP * 12;
                runningInvested += yearlySIP;
                
                // Previous value grows + new SIP added
                runningValue = runningValue * (1 + expectedCAGR) + yearlySIP;
                
                const annualGain = runningValue - runningInvested - cumulativeGain;
                cumulativeGain = runningValue - runningInvested;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date().getFullYear() + year}</td>
                        <td>${formatCurrency(yearlySIP)}</td>
                        <td>${formatCurrency(runningInvested)}</td>
                        <td>${formatCurrency(runningValue)}</td>
                        <td class="positive">${formatCurrency(annualGain)}</td>
                        <td class="positive">${formatCurrency(cumulativeGain)}</td>
                    </tr>
                `;
            }
            
            // Projection chart
            if (charts.projection) charts.projection.destroy();
            
            const labels = ['Current'];
            const investedSeries = [currentInvested];
            const valueSeries = [currentValue];
            
            runningValue = currentValue;
            runningInvested = currentInvested;
            
            for (let year = 1; year <= years; year++) {
                labels.push('Year ' + year);
                runningInvested += monthlySIP * 12;
                runningValue = runningValue * (1 + expectedCAGR) + monthlySIP * 12;
                investedSeries.push(runningInvested);
                valueSeries.push(runningValue);
            }
            
            const ctx = document.getElementById('projectionChart').getContext('2d');
            charts.projection = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Invested',
                        data: investedSeries,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true
                    }, {
                        label: 'Portfolio Value',
                        data: valueSeries,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + (value/10000000).toFixed(1) + 'Cr';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        function formatCurrency(value) {
            if (value >= 10000000) {
                return '‚Çπ' + (value / 10000000).toFixed(2) + 'Cr';
            } else if (value >= 100000) {
                return '‚Çπ' + (value / 100000).toFixed(2) + 'L';
            } else if (value >= 1000) {
                return '‚Çπ' + (value / 1000).toFixed(2) + 'K';
            }
            return '‚Çπ' + value.toFixed(2);
        }
    </script>
</body>
</html>